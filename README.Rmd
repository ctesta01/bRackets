---
title: bRackets
output: github_document
---

Currently in progress -- 

We're working on figuring out a system compatible with ggplot2 for annotating
figures with labelled brackets with a particular interest in annotating
significance results.

![](graphics/error_bars_example.png)

## Installation Instructions 

Remember:  This project is currently under
active development and no promises are made
that it works (yet). 

If you'd like to install it so you can 
load and use the `build_bracket` and 
`add_brackets` functions, you may do so using

```r
remotes::install_github("ctesta01/bRackets")
```

## Demonstration 

```{r}
#| fig.width: 8
#| fig.height: 4
#| message: FALSE
#| warning: FALSE
#| out.width: '100%'
library(dplyr)
library(ggplot2)
library(readr)
library(purrr)
devtools::load_all(".")

# load data ---------------------------------------------------------------

df <- readr::read_csv("data_annotated.csv")

df_err <- df %>%
  group_by(group, week) %>%
  summarise(
    y_mean = mean(y),
    ymin   = min(y),
    ymax   = max(y),
    .groups = "drop"
  )

# make a ggplot2 plot  (doesn't have bracket annotations yet) ---------------------------------------------

plt <- ggplot(df, aes(x = week, y = y, color = group, group = group)) +
  geom_point(
    data = df |> filter(is.na(error_type)),
    size = 2) +
  geom_errorbar(
    data = df_err,
    aes(ymin = ymin, ymax = ymax, y = NULL),
    width = 0.15,
    linewidth = 0.8
  ) +
  geom_line(
    data = df_err,
    aes(y = y_mean),
    linewidth = 0.8
  ) +
  theme_minimal() +
  xlab("Week Number") +
  ylab("log-transform") +
  theme(
    axis.title.y = element_text(angle = 0, vjust = 0.5))


# helper function ---------------------------------------------------------


# Helpers to pull values (mean by default)
pull_y <- function(g, w, stat = c("y_mean","ymin","ymax")) {
  stat <- match.arg(stat)
  df_err %>% filter(group == g, week == w) %>% pull(.data[[stat]])
}


# determine bracket positions ------------------------------------------------------

# These are all layout positioning calculations: The user should set whatever
# position they want for their brackets.  Positions can either be determined via
# code or also by hand.

# Numeric x positions for discrete weeks (W1 = 1, W2 = 2)
x_W1 <- 1
x_W2 <- 2

# 1) Week 1: High vs Control (vertical bracket)
y_high_W1 <- pull_y("High", "W1", "y_mean")
y_ctrl_W1 <- pull_y("Control", "W1", "y_mean")

# 2) Week 1: Control vs Low (vertical bracket)
y_low_W1  <- pull_y("Low", "W1", "y_mean")

# 3) High group change W1->W2 (horizontal dashed bracket near top)
y_high_W2 <- pull_y("High", "W2", "y_mean")
y_high_top <- max(y_high_W1, y_high_W2) + 0.35  # put bracket above the points
y_high_bottom <- min(y_high_W1, y_high_W2) - 0.35  # put bracket below the points


# 4) Low group change W1->W2 (horizontal dashed bracket near bottom)
y_low_W2 <- pull_y("Low", "W2", "y_mean")
y_low_bottom <- min(y_low_W1, y_low_W2) - 0.35     # put bracket below the points; tweak as needed


# Setup Specification for Brackets -------------------------------------------------

# Here is where all the setup is done: 
# The user should specify a list specifying how each bracket should be formatted.

bracket_specs <- list(
  # Week 1: High vs Control (bracket is on the LEFT of W1; ticks point inward to the RIGHT)
  list(
    orientation = "v",
    x0 = x_W1 - 0.22,          # bracket location left of W1
    y0 = y_ctrl_W1,
    y1 = y_high_W1,
    position = "left",
    tick = 0.10,
    pad = 0.05,
    text = "***  d = 1.65",
    color = "black",
    linewidth = 0.9
  ),

  # Week 1: Control vs Low (also on the LEFT)
  list(
    orientation = "v",
    x0 = x_W1 - 0.34,
    y0 = y_low_W1,
    y1 = y_ctrl_W1,
    position = "left",
    tick = 0.10,
    pad = 0.05,
    text = "***  d = -1.60",
    color = "black",
    linewidth = 0.9
  ),

  # High: W1 -> W2 (TOP dashed bracket; ticks point DOWN; label goes ABOVE)
  list(
    orientation = "h",
    x0 = x_W1, x1 = x_W2,
    y0 = y_high_top + .5,
    position = "top",
    tick = 0.10,
    text = "***  d = -0.76",
    color = "black",
    linewidth = 0.9,
    linetype = "dashed"
  ),

  # Low: W1 -> W2 (BOTTOM dashed bracket; ticks point UP; label goes BELOW)
  list(
    orientation = "h",
    x0 = x_W1, x1 = x_W2,
    y0 = y_low_bottom - .5,
    position = "bottom",
    tick = 0.10,
    text = "*  d = 0.74",
    color = "black",
    linewidth = 0.9,
    linetype = "dashed"
  )
)


# Adding Brackets ---------------------------------------------------------

# Add brackets to our plot
plt2 <- add_brackets(plt, bracket_specs) +
  coord_cartesian(clip = "off") +
  theme(plot.margin = margin(5.5, 30, 5.5, 30))

plt2


# example showing with facets ---------------------------------------------

plt <- plt + facet_wrap(~group)

bracket_specs <- list(
  list(
    orientation = "h",
    x0 = x_W1, x1 = x_W2,
    y0 = y_high_bottom - .5,
    position = "bottom",
    tick = 0.10,
    text = "***  d = -0.76",
    color = "black",
    linewidth = 0.9,
    linetype = "dashed",
    facet_vars=list(group="High")  # <- only appears in High panel
  ),
  list(
    orientation = "h",
    x0 = x_W1, x1 = x_W2,
    y0 = y_low_bottom - .5,
    position = "bottom",
    tick = 0.10,
    text = "*  d = 0.74",
    color = "black",
    linewidth = 0.9,
    linetype = "dashed",
    facet_vars=list(group="Low")   # <- only appears in Low panel
  )
)

plt2 <- add_brackets(plt, bracket_specs)

plt2 +
  coord_cartesian(clip = "off") +
  theme(plot.margin = margin(5.5, 30, 5.5, 30))
```
